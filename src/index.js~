import { h, render, Component } from "preact";
import "./slajder.css";
import "./scss/background.scss";
import contact from "./contact.txt";
import bio from "./bio.txt";
import news from "./whatsnew.js";
import styles from "./scss/variables.scss";

const filesList = styles.filesList.split(" ");

let currBackground = 0;
let currBackgroundClass = null;

//this will be the index of the background image to be displayed to the user. On the desktop, when the user hovers, the image will be changed. On mobile every 10 secs.

console.log(filesList);

const hiRes = require.context("../slk/height1024", true);
const medRes = require.context("../slk/height700", true);
const lowRes = require.context("../slk/height500", true);

const choosenRes = !window.screen
  ? hiRes
  : window.screen.width > 1600
    ? hiRes
    : window.sreen.width < 700
      ? lowRes
      : medRes;

const preloadImage = ind => {
  return new Promise((resolve, reject) => {
    let img = new Image();
    let pth = "./" + filesList[ind] + ".jpg";
    img.src = choosenRes(pth);
    img.onload = () => {
      resolve("loaded");
    };
    img.onerror = err => {
      reject(err);
    };
    img.onabort = () => {
      reject("aborted");
    };
  });
};

const loadBackground = ind => {
  //it will try to load the image to the browser cache first. When it is loaded it changes the background
  if (currBackgroundClass) {
    document.documentElement.classList.remove(currBackgroundClass);
  }
  currBackgroundClass = "main-bg-" + (ind + 1);
  document.documentElement.classList.add(currBackgroundClass);
  document.documentElement.classList.add("thumb");

  return preloadImage(ind).then(_ => {
    document.documentElement.classList.remove("thumb");
  });
};

const loadImages = () => {
  //wait for the first image to load, then loads the rest
  loadBackground(0).then(() => {
    for (let j = 1; j < filesList.length; j++) {
      //skip first, alerady loaded
      preloadImage(j);
    }
  });
};

const LOAD_AFTER = 10000;
let imageCounter = 0;
let timeoutRun = true;

const timeoutLoop = () => {
  if (!timeoutRun) return;
  imageCounter = imageCounter + 1;
  if (imageCounter == filesList.length) imageCounter = 0;
  setTimeout(_ => {
    loadBackground(imageCounter);
    timeoutLoop();
  }, LOAD_AFTER);
};

loadImages();
timeoutLoop();
